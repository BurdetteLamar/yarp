################################################################################
# This file is generated by the bin/template script and should not be          #
# modified manually.                                                           #
################################################################################

require "stringio"

module YARP
  module Serialize
    def self.load(source, serialized)
      io = StringIO.new(serialized)
      io.set_encoding(Encoding::BINARY)
      Loader.new(source, io).load
    end

    class Loader
      attr_reader :source, :io

      def initialize(source, io)
        @source = source
        @io = io
      end

      def load
        io.read(4) => "YARP"
        io.read(3).unpack("C3") => [0, 1, 0]
        load_node
      end

      private

      def load_token
        number, start_offset, end_offset = io.read(17).unpack("CQQ")
        type =
          case number
          <%- tokens.each_with_index do |token, index| -%>
          when <%= index %> then :<%= token.name %>
          <%- end -%>
          end

        location = YARP::Location.new(start_offset, end_offset)
        YARP::Token.new(type, source[start_offset...end_offset], location)
      end

      def load_optional_node
        if io.read(1).unpack1("C") != 0
          io.pos -= 1
          load_node
        end
      end

      def load_optional_token
        if io.read(1).unpack1("C") != 0
          io.pos -= 1
          load_token
        end
      end

      def load_string
        length = io.read(8).unpack1("Q")
        io.read(length)
      end

      def load_node
        type, _length, start_offset, end_offset = io.read(25).unpack("CQQQ")
        location = YARP::Location.new(start_offset, end_offset)

        case type
        <%- nodes.each_with_index do |node, index| -%>
        when <%= index %> then YARP::<%= node.name %>.new(<%= node.params.map { |param|
          case param
          when NodeParam then "load_node"
          when OptionalNodeParam then "load_optional_node"
          when StringParam then "load_string"
          when NodeListParam then "io.read(8).unpack1(\"Q\").times.map { load_node }"
          when TokenParam then "load_token"
          when TokenListParam then "io.read(8).unpack1(\"Q\").times.map { load_token }"
          when OptionalTokenParam then "load_optional_token"
          else raise
          end
        }.join(", ") -%>, location)
        <%- end -%>
        end
      end
    end
  end
end
